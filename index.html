 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>
  <!-- Make sure you put this AFTER Leaflet's CSS -->
 <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
   integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
   crossorigin=""></script>

 <script src="leaflet.rotatedMarker.js"></script>

 <script>
  var red_line = {
      "NORTH SPRINGS STATION": [964.125, 587.125],
      "SANDY SPRINGS STATION": [909.5, 607.5],
      "DUNWOODY STATION": [855.375, 631.125],
      "MEDICAL CENTER STATION": [804.25, 615.75],
      "BUCKHEAD STATION": [695.875, 586.5],
      "LINDBERGH CENTER STATION": [617.375, 554.375],
      "ARTS CENTER STATION": [543.25, 514],
      "MIDTOWN STATION": [512.75, 515],
      "NORTH AVENUE STATION": [481.125, 514.75],
      "CIVIC CENTER STATION": [451.25, 515.125],
      "PEACHTREE CENTER STATION": [409.625, 514.75],
      "FIVE POINTS STATION": [360.375, 514.25],
      "GARNETT STATION": [321.75, 490],
      "WEST END STATION": [265.125, 450.625],
      "OAKLAND CITY STATION": [231.75, 451],
      "LAKEWOOD STATION": [198.5, 451.125],
      "EAST POINT STATION": [165.875, 450.875],
      "COLLEGE PARK STATION": [115.375, 450.875],
      "AIRPORT STATION": [32.5, 502.25],
  };

  var red_line_north_ns = {
      "NORTH SPRINGS STATION": "NORTH SPRINGS STATION",
      "SANDY SPRINGS STATION": "NORTH SPRINGS STATION",
      "DUNWOODY STATION": "SANDY SPRINGS STATION",
      "MEDICAL CENTER STATION": "DUNWOODY STATION",
      "BUCKHEAD STATION": "MEDICAL CENTER STATION",
      "LINDBERGH CENTER STATION": "BUCKHEAD STATION",
      "ARTS CENTER STATION": "LINDBERGH CENTER STATION",
      "MIDTOWN STATION": "ARTS CENTER STATION",
      "NORTH AVENUE STATION": "MIDTOWN STATION",
      "CIVIC CENTER STATION": "NORTH AVENUE STATION",
      "PEACHTREE CENTER STATION": "CIVIC CENTER STATION",
      "FIVE POINTS STATION": "PEACHTREE CENTER STATION",
      "GARNETT STATION": "FIVE POINTS STATION",
      "WEST END STATION": "GARNETT STATION",
      "OAKLAND CITY STATION": "WEST END STATION",
      "LAKEWOOD STATION": "OAKLAND CITY STATION",
      "EAST POINT STATION": "LAKEWOOD STATION",
      "COLLEGE PARK STATION": "EAST POINT STATION",
      "AIRPORT STATION": "COLLEGE PARK STATION",
  };

  var red_line_south_ns = {
      "NORTH SPRINGS STATION": "SANDY SPRINGS STATION",
      "SANDY SPRINGS STATION": "DUNWOODY STATION",
      "DUNWOODY STATION": "MEDICAL CENTER STATION",
      "MEDICAL CENTER STATION": "BUCKHEAD STATION",
      "BUCKHEAD STATION": "LINDBERGH CENTER STATION",
      "LINDBERGH CENTER STATION": "ARTS CENtER STATION",
      "ARTS CENTER STATION": "MIDTOWN STATION",
      "MIDTOWN STATION": "NORTH AVENUE STATION",
      "NORTH AVENUE STATION": "CIVIC CENTER STATION",
      "CIVIC CENTER STATION": "PEACHTREE CENTER STATION",
      "PEACHTREE CENTER STATION": "FIVE POINTS STATION",
      "FIVE POINTS STATION": "GARNETT STATION",
      "GARNETT STATION": "WEST END STATION",
      "WEST END STATION": "OAKLAND CITY STATION",
      "OAKLAND CITY STATION": "LAKEWOOD STATION",
      "LAKEWOOD STATION": "EAST POINT STATION",
      "EAST POINT STATION": "COLLEGE PARK STATION",
      "COLLEGE PARK STATION": "AIRPORT STATION",
      "AIRPORT STATION": "AIRPORT STATION",
  };

  var L = L;
  var map = null;
  var layerGroup = null
  var poll = true;
  var boardingMap = {};

  function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
  }

  window.addEventListener('DOMContentLoaded', (event) => {
      map = L.map('mapid', {
          crs: L.CRS.Simple
      });
      var bounds = [
          [0, 0],
          [1000, 1000]
      ];
      var image = L.imageOverlay('img/martamap.jpg', bounds).addTo(map);
      map.fitBounds(bounds);
      map.on('click', function(ev) {
          var latlng = map.mouseEventToLatLng(ev.originalEvent);
          console.log(latlng.lat + ', ' + latlng.lng);
      });
      layerGroup = L.layerGroup().addTo(map);
  });

  async function pollForTrains() {
      for (;;) {
          if (poll) {
              console.log("rendering trains")
              layerGroup.clearLayers();
              renderTrains();
              await sleep(5000 * 4);
          } else {
              console.log("polling flag turned off");
              return;
          }
      }
  }

  function lastBoarding(station, direction) {
      if (direction === "N") {
          if (boardingMap[red_line_south_ns[station] + "N"]) {
              return red_line_south_ns[station] + "N"
          }
      } else {
          if (boardingMap[red_line_north_ns[station] + "S"]) {
              return red_line_north_ns[station] + "S"
          }
      }
      return null
  }

  function getInterpolationCoords(station1, station2, timeToStation2) {
      if (timeToStation2 <= 0) {
          return station2
      }
      s1x = station1[0]
      s1y = station1[1]
      s2x = station2[0]
      s2y = station2[1]
      sx = (s2x + s1x) / 2
      sy = (s2y + s1y) / 2
      return [sx, sy]
  }

  var north_train = L.icon({
      iconUrl: 'img/train.svg',

      iconSize: [25, 10], // size of the icon
  });

  function rotation(direction) {
      return direction === "S" ? 90 : -90
  }

  function addMarker(coords, direction, text) {
      var sol = L.latLng(coords);
      L.marker(sol, {
          icon: north_train,
          rotationAngle: rotation(direction)
      }).addTo(layerGroup).bindPopup(text);
  }

  function returnNextStation(direction, station) {
      return direction === "S" ? red_line_south_ns[station] : red_line_north_ns[station];
  }

  function returnNextStationCoords(direction, station) {
      return direction === "S" ? red_line[red_line_south_ns[station]] : red_line[red_line_north_ns[station]];
  }

  function returnLastStationCoords(direction, station) {
      return direction === "S" ? red_line[red_line_north_ns[station]] : red_line[red_line_south_ns[station]];
  }

  async function renderTrains() {
      let schedule = await getResponse()
      let currBoarding = {};
      let boardingList = [];
      let inTransitList = [];
      for (idx in schedule) {
          station = schedule[idx]
          if (station["STATION"] in red_line) {
              if (station["DIRECTION"] === "N" || station["DIRECTION"] === "S") {
                  if (station["WAITING_TIME"] === "Boarding") {
		      currBoarding[station["STATION"] + station["DIRECTION"]] = true;
                      if (lastBoarding(station["STATION"], station["DIRECTION"])) {
                          delete boardingMap[lastBoarding(station["STATION"], station["DIRECTION"])]
                      }
                      boardingMap[station["STATION"] + station["DIRECTION"]] = true;
		      boardingList.push(station);
                      addMarker(red_line[station["STATION"]], station["DIRECTION"], station["DIRECTION"] + " boarding at " + station["STATION"]);
                  }
              }
          }
      }
      for (idx in schedule) {
          station = schedule[idx]
          if (station["STATION"] in red_line) {
              if (station["DIRECTION"] === "N" || station["DIRECTION"] === "S") {
		  if (lastBoarding(station["STATION"], station["DIRECTION"]) != null && !(lastBoarding(station["STATION"], station["DIRECTION"]) in currBoarding)) {
		      newCoords = getInterpolationCoords(returnLastStationCoords(station["DIRECTION"], station["STATION"]), red_line[station["STATION"]])
		      addMarker(newCoords, station["DIRECTION"], station["DIRECTION"] + " heading to " + station["STATION"]);
		      inTransitList.push(station)
		  }
	      }
          }
      }
      console.log("Trains that are boarding: ", boardingList);
      console.log("Trains that are in transit: ", inTransitList);
  }

  async function getResponse() {
      const response = await fetch('/marta');
      const myJson = await response.json();
      return myJson
  } </script>

 <style>
  html, body {
      height: 100%;
  }
  #mapid {
      height: 100%;
      background: #000;
  }
 </style>
 <body>
     <div id="mapid"></div>
</body>
